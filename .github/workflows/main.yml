name: Main TheLikes workflow

on: [push]

jobs:
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      nginx: ${{ steps.filter.outputs.nginx }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v5
      - name: filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            nginx:
              - 'nginx/**'

  backend_tests:
    needs: detect_changes
    if: ${{needs.detect_changes.outputs.backend == 'true'}}
    runs-on: ubuntu-latest
    env:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: test_db
      JWT_SECRET: jwttestsecret
      JWT_ACCESS_LIFETIME_MINUTES: 5
      JWT_ALGORITHM: HS256
      RESET_PASSWORD_TOKEN_SECRET: jwtresettestsecret
      VERIFICATION_TOKEN_SECRET: jwtverificationtestsecret
      DEFAULT_LANGUAGE: en
      TRANSLATE_TO: ru
      REDIS_HOST: localhost
      REDIS_PORT: 6379
      REDIS_DB: 0
      EMAIL_APP_EMAIL: placeholder@example.com
      EMAIL_APP_NAME: placeholder@example.com
      EMAIL_APP_PASSWORD: placeholder
      LOG_PATH: ${{ github.workspace }}/logs/logger_log.log
      BACKEND_ORIGIN: "http://localhost:8000"
      FRONTEND_ORIGIN: "http://localhost:3000"

    services:
      postgres:
        image: postgis/postgis:18-3.6
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Check out repo
        uses: actions/checkout@v5
      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          cd backend
          pip install uv
          UV_DEV=False uv sync --frozen
      - name: Lint with ruff
        run: |
          cd backend
          uv run ruff check
      - name: Create logs in workspace
        run: |
          mkdir -p logs
          chmod 755 logs
      - name: Migrations
        run: |
          cd backend
          uv run alembic upgrade head
      - name: Prepare data
        run: |
          cd backend
          uv run python prepare.py data
      - name: Start app
        run: |
          cd backend
          uv run fastapi dev src/main.py &
          sleep 10 &
          uv run celery -A src.tasks worker --loglevel=info &
          sleep 10 &
          uv run celery -A src.tasks beat --loglevel=info &
          sleep 10
      - name: Test with pytest
        run: |
          cd backend
          uv run pytest -v

  build_backend_and_push_to_docker_hub:
    needs:
      - backend_tests
    name: Push backend image to DockerHub
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN  }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Buid and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:backend"
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/the_likes_backend:latest

  build_nginx_and_push_to_docker_hub:
    needs: detect_changes
    if: ${{needs.detect_changes.outputs.nginx == 'true'}}
    name: Push nginx image to DockerHub
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN  }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Buid and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: "{{defaultContext}}:nginx"
          push: true
          tags: ${{ vars.DOCKERHUB_USERNAME }}/the_likes_nginx:latest
